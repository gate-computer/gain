<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>talk</title>
		<style>
			body {
				margin: 0;
			}

			#output {
				margin: 0;
				padding: 8px;
				list-style-type: none;
				font-family: monospace;
			}

			.info {
				opacity: 0.5;
				white-space: pre-wrap;
			}
		</style>
	</head>
	<body>
		<ul id="output"></ul>
		<script>

(function() {
	let output = document.getElementById("output")

	function displayMessage(text) {
		let li = document.createElement("li")
		li.innerText = text
		output.appendChild(li)
		output.scrollIntoView(false)
		return li
	}

	function displayInfoMessage(text) {
		let li = displayMessage(text)
		li.classList.add("info")
	}

	function displayIOMessage(data) {
		displayMessage(new TextDecoder("utf-8").decode(data))
	}

	const PROG = "payload/prog.wasm" // "../../tests/hello/prog.wasm"
	const ADDR = "localhost:8888"
	const RUN_SOCKET = true
	const RUN_POST = false
	const IO_SOCKET = true

	let prog = new XMLHttpRequest()
	prog.responseType = "arraybuffer"
	prog.open("GET", PROG)
	prog.send()

	prog.onload = () => {
		crypto.subtle.digest("SHA-384", prog.response).then((digest) => {
			let hash = btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, "-").replace(/\//g, "_")

			if (RUN_SOCKET) {
				let run = new WebSocket("ws://" + ADDR + "/run")
				run.binaryType = "arraybuffer"

				run.onopen = () => {
					run.send(JSON.stringify({program_sha384: hash}))
					run.send(prog.response)
				}

				run.onmessage = (event) => {
					if (typeof event.data === "string")
						displayInfoMessage(event.data)
					else
						displayIOMessage(event.data)
				}
			} else {
				let load = new XMLHttpRequest()
				load.open("POST", "http://" + ADDR + "/load")
				load.setRequestHeader("Content-Type", "application/wasm")
				load.setRequestHeader("X-Gate-Program-Sha384", hash)
				load.send(prog.response)

				load.onload = () => {
					displayInfoMessage(load.response)
					let loaded = JSON.parse(load.response)

					if (RUN_POST) {
						let run = new XMLHttpRequest()
						run.responseType = "arraybuffer"
						run.open("POST", "http://" + ADDR + "/run")
						run.setRequestHeader("X-Gate-Program-Id", loaded.program.id)
						run.setRequestHeader("X-Gate-Program-Sha384", hash)
						run.send()

						run.onload = () => {
							displayInfoMessage("X-Gate-Instance-Id: " + run.getResponseHeader("X-Gate-Instance-Id"))
							displayIOMessage(run.response)
						}
					} else {
						let spawn = new XMLHttpRequest()
						spawn.open("POST", "http://" + ADDR + "/spawn")
						spawn.setRequestHeader("Content-Type", "application/json")
						spawn.send(JSON.stringify({program: loaded.program}))

						spawn.onload = () => {
							displayInfoMessage(spawn.response)
							let spawned = JSON.parse(spawn.response)

							var waiting = false

							function wait() {
								if (waiting)
									return

								waiting = true

								let wait = new XMLHttpRequest()
								wait.open("POST", "http://" + ADDR + "/wait")
								wait.setRequestHeader("Content-Type", "application/json")
								wait.send(JSON.stringify({instance: spawned.instance}))

								wait.onload = () => {
									displayInfoMessage(wait.response)
								}
							}

							if (IO_SOCKET) {
								let io = new WebSocket("ws://" + ADDR + "/io")
								io.binaryType = "arraybuffer"

								io.onopen = () => {
									io.send(JSON.stringify({instance: spawned.instance}))
								}

								io.onmessage = (event) => {
									if (typeof event.data === "string")
										wait()
									else
										displayIOMessage(event.data)
								}
							} else {
								let io = new XMLHttpRequest()
								io.responseType = "arraybuffer"
								io.open("POST", "http://" + ADDR + "/io")
								io.setRequestHeader("X-Gate-Instance-Id", spawned.instance.id)
								io.send()

								io.onloadstart = wait
								io.onprogress = wait
								io.onloadend = wait

								io.onload = () => {
									displayIOMessage(io.response)
								}
							}
						}
					}
				}
			}
		})
	}
}())

		</script>
	</body>
</html>
