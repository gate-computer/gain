<!--*- mode: javascript -*-->

<script src="run.js"></script>
<script>

(function() {
	let serviceRegistry = {
		getInfo(name) {
			console.log("getting info of service", name)

			var atom
			var version

			switch (name) {
			case "test1":
				atom = 1
				version = 1337
				break

			case "test2":
				atom = 2
				version = 12765
				break
			}

			return {atom, version}
		},

		createMessenger(sendMessage) {
			console.log("creating service messenger")

			return {
				handleMessage(op) {
					let header = new DataView(op)
					let atom = header.getUint32(8, true)
					var ok = false

					switch (atom) {
					case 1:
					case 2:
						ok = true
						break
					}

					return ok
				},

				close() {
					console.log("service messenger closed")
				},
			}
		},
	}

	function handleOrigin(data) {
		if (data.byteLength == 0) {
			console.log("origin: EOF")
			return
		}

		let bytes = new Uint8Array(data)
		var text = ""

		for (var i = 0; i < bytes.length; i++)
			text += String.fromCharCode(bytes[i])

		console.log("origin:", bytes, text)
	}

	var exited = false

	function handleExit(status) {
		console.log("exit:", status)
		exited = true
	}

	let url = "../tests/" + location.hash.substring(1) + "/prog.wasm"

	let xhr = new XMLHttpRequest()
	xhr.responseType = "arraybuffer"
	xhr.open("GET", url)
	xhr.send()
	xhr.onload = () => {
		let runner = new Gate.Runner(xhr.response, serviceRegistry)
		runner.onorigin = handleOrigin
		runner.onexit = handleExit
		runner.run()

		setTimeout(() => {
			if (exited)
				return

			let data = new DataView(new ArrayBuffer(1))
			data.setUint8(0, 43)
			runner.sendOrigin(data.buffer)
		}, 333)
	}
}())

</script>
