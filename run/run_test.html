<!--*- mode: javascript -*-->

<script src="run.js"></script>
<script>

(function() {
	let serviceRegistry = {
		getInfo(name) {
			console.log("getting info of service", name)

			var code
			var version = 0

			switch (name) {
			case "origin":
				code = 1
				break

			case "test1":
				code = 2
				version = 1337
				break

			case "test2":
				code = 3
				version = 12765
				break
			}

			return {code, version}
		},

		createMessenger(sendMessage) {
			console.log("creating service messenger")

			return {
				handleMessage(op) {
					switch (new DataView(op).getUint16(6, true)) {
					case 1:
						if (op.byteLength == 8) {
							console.log("origin: EOF")
							return
						}

						let bytes = new Uint8Array(op, 8)
						var text = ""

						for (var i = 0; i < bytes.length; i++)
							text += String.fromCharCode(bytes[i])

						console.log("origin:", bytes, text)
						break

					case 2:
					case 3:
						// ok
						break

					default:
						throw "invalid service code"
					}
				},

				shutdown() {
					console.log("service messenger shutdown")
				},
			}
		},
	}

	var exited = false

	function handleExit(status) {
		console.log("exit:", status)
		exited = true
	}

	let url = "../tests/" + location.hash.substring(1) + "/prog.wasm"

	let xhr = new XMLHttpRequest()
	xhr.responseType = "arraybuffer"
	xhr.open("GET", url)
	xhr.send()
	xhr.onload = () => {
		let runner = new Gate.Runner(xhr.response, serviceRegistry)
		runner.onexit = handleExit
		runner.run()
	}
}())

</script>
