<!--*- mode: javascript -*-->

<script src="run.js"></script>
<script>

(function() {
	let ifaces = {
		getInfo(name) {
			var atom
			var version

			switch (name) {
			case "test1":
				atom = 1
				version = 1337
				break

			case "test2":
				atom = 2
				version = 12765
				break
			}

			return {atom, version}
		},

		onmessage(payload, interfaceAtom) {
			var found = false

			switch (interfaceAtom) {
			case 1:
			case 2:
				found = true
				break
			}

			return found
		},
	}

	function handleOrigin(data) {
		let bytes = new Uint8Array(data)
		var text = ""

		for (var i = 0; i < bytes.length; i++)
			text += String.fromCharCode(bytes[i])

		console.log("origin:", bytes, text)
	}

	function handleExit(status) {
		console.log("exit:", status)
	}

	let url = "../tests/" + location.hash.substring(1) + "/prog.wasm"

	let xhr = new XMLHttpRequest()
	xhr.responseType = "arraybuffer"
	xhr.open("GET", url)
	xhr.send()
	xhr.onload = () => {
		let runner = new Gate.Runner(xhr.response, ifaces)
		runner.onorigin = handleOrigin
		runner.onexit = handleExit
		runner.run()

		setTimeout(() => {
			let data = new DataView(new ArrayBuffer(1))
			data.setUint8(0, 43)
			runner.sendOrigin(data.buffer)
		}, 333)
	}
}())

</script>
