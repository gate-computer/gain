<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>talk</title>
		<style>
			body {
				margin: 0;
			}

			#output {
				margin: 0;
				padding: 8px;
				list-style-type: none;
				font-family: monospace;
			}

			.protocol {
				opacity: 0.5;
				white-space: pre-wrap;
			}
		</style>
	</head>
	<body>
		<ul id="output"></ul>
		<script>

(function() {
	let output = document.getElementById("output")

	function displayMessage(text) {
		let li = document.createElement("li")
		li.innerText = text
		output.appendChild(li)
		output.scrollIntoView(false)
		return li
	}

	function displayProtocolMessage(text) {
		let li = displayMessage(text)
		li.classList.add("protocol")
	}

	function displayOriginMessage(data) {
		displayMessage(new TextDecoder("utf-8").decode(data))
	}

	const PROG = "payload/prog.wasm" // "../../tests/hello/prog.wasm"
	const ADDR = "localhost:8888"
	const WEBSOCKET_ONLY = false
	const WEBSOCKET_ORIGIN = true

	let prog = new XMLHttpRequest()
	prog.responseType = "arraybuffer"
	prog.open("GET", PROG)
	prog.send()

	prog.onload = () => {
		let checksum = new XMLHttpRequest()
		checksum.open("GET", PROG + ".sha512sum")
		checksum.send()

		checksum.onload = () => {
			let hash = checksum.response.split(" ")[0]

			if (WEBSOCKET_ONLY) {
				let conn = new WebSocket("ws://" + ADDR + "/run-origin-wait")
				conn.binaryType = "arraybuffer"

				conn.onopen = () => {
					conn.send(prog.response)
				}

				conn.onmessage = (event) => {
					if (typeof event.data === "string")
						displayProtocolMessage(event.data)
					else
						displayOriginMessage(event.data)
				}
			} else {
				let load = new XMLHttpRequest()
				load.open("POST", "http://" + ADDR + "/load")
				load.setRequestHeader("Content-Type", "application/wasm")
				load.setRequestHeader("X-Content-Sha512-Hex", hash)
				load.send(prog.response)

				load.onload = () => {
					displayProtocolMessage(load.response)
					let loaded = JSON.parse(load.response)

					let run = new XMLHttpRequest()
					run.open("POST", "http://" + ADDR + "/run")
					run.setRequestHeader("Content-Type", "application/json")
					run.send(JSON.stringify({program: loaded.program}))

					run.onload = () => {
						displayProtocolMessage(run.response)
						let running = JSON.parse(run.response)

						var waiting = false

						function wait() {
							if (waiting)
								return

							waiting = true

							let wait = new XMLHttpRequest()
							wait.open("POST", "http://" + ADDR + "/wait")
							wait.setRequestHeader("Content-Type", "application/json")
							wait.send(JSON.stringify({instance: running.instance}))

							wait.onload = () => {
								displayProtocolMessage(wait.response)
							}
						}

						if (WEBSOCKET_ORIGIN) {
							let origin = new WebSocket("ws://" + ADDR + "/origin")
							origin.binaryType = "arraybuffer"

							origin.onopen = () => {
								origin.send(JSON.stringify({instance: running.instance}))
							}

							origin.onmessage = (event) => {
								wait()

								if (typeof event.data != "string")
									displayOriginMessage(event.data)
							}
						} else {
							let origin = new XMLHttpRequest()
							origin.responseType = "arraybuffer"
							origin.open("POST", "http://" + ADDR + "/origin/" + running.instance.id)
							origin.send()

							origin.onloadstart = wait
							origin.onprogress = wait
							origin.onloadend = wait

							origin.onload = () => {
								displayOriginMessage(origin.response)
							}
						}
					}
				}
			}
		}
	}
}())

		</script>
	</body>
</html>
