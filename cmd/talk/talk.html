<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>talk</title>
		<style>
			body {
				margin: 0;
			}

			#output {
				margin: 0;
				padding: 8px;
				list-style-type: none;
				font-family: monospace;
			}

			.info {
				opacity: 0.5;
				white-space: pre-wrap;
			}
		</style>
	</head>
	<body>
		<ul id="output"></ul>
		<script>

(function() {
	let output = document.getElementById("output")

	function displayMessage(text) {
		let li = document.createElement("li")
		li.innerText = text
		output.appendChild(li)
		output.scrollIntoView(false)
		return li
	}

	function displayInfoMessage(text) {
		let li = displayMessage(text)
		li.classList.add("info")
	}

	function displayCommMessage(data) {
		displayMessage(new TextDecoder("utf-8").decode(data))
	}

	const PROG = "payload/prog.wasm" // "../../tests/hello/prog.wasm"
	const ADDR = "localhost:8888"
	const RUN_WEBSOCKET = true
	const RUN_POST = false
	const COMM_WEBSOCKET = true

	let prog = new XMLHttpRequest()
	prog.responseType = "arraybuffer"
	prog.open("GET", PROG)
	prog.send()

	prog.onload = () => {
		let checksum = new XMLHttpRequest()
		checksum.open("GET", PROG + ".sha512sum")
		checksum.send()

		checksum.onload = () => {
			let hash = checksum.response.split(" ")[0]

			if (RUN_WEBSOCKET) {
				let run = new WebSocket("ws://" + ADDR + "/run")
				run.binaryType = "arraybuffer"

				run.onopen = () => {
					run.send(prog.response)
				}

				run.onmessage = (event) => {
					if (typeof event.data === "string")
						displayInfoMessage(event.data)
					else
						displayCommMessage(event.data)
				}
			} else {
				let load = new XMLHttpRequest()
				load.open("POST", "http://" + ADDR + "/load")
				load.setRequestHeader("Content-Type", "application/wasm")
				load.setRequestHeader("X-Gate-Program-Sha512", hash)
				load.send(prog.response)

				load.onload = () => {
					displayInfoMessage(load.response)
					let loaded = JSON.parse(load.response)

					if (RUN_POST) {
						let run = new XMLHttpRequest()
						run.responseType = "arraybuffer"
						run.open("POST", "http://" + ADDR + "/run")
						run.setRequestHeader("X-Gate-Program-Id", loaded.program.id)
						run.setRequestHeader("X-Gate-Program-Sha512", hash)
						run.send()

						run.onload = () => {
							displayInfoMessage("X-Gate-Instance-Id: " + run.getResponseHeader("X-Gate-Instance-Id"))
							displayCommMessage(run.response)
						}
					} else {
						let spawn = new XMLHttpRequest()
						spawn.open("POST", "http://" + ADDR + "/spawn")
						spawn.setRequestHeader("Content-Type", "application/json")
						spawn.send(JSON.stringify({program: loaded.program}))

						spawn.onload = () => {
							displayInfoMessage(spawn.response)
							let spawned = JSON.parse(spawn.response)

							var waiting = false

							function wait() {
								if (waiting)
									return

								waiting = true

								let wait = new XMLHttpRequest()
								wait.open("POST", "http://" + ADDR + "/wait")
								wait.setRequestHeader("Content-Type", "application/json")
								wait.send(JSON.stringify({instance: spawned.instance}))

								wait.onload = () => {
									displayInfoMessage(wait.response)
								}
							}

							if (COMM_WEBSOCKET) {
								let comm = new WebSocket("ws://" + ADDR + "/communicate")
								comm.binaryType = "arraybuffer"

								comm.onopen = () => {
									comm.send(JSON.stringify({instance: spawned.instance}))
								}

								comm.onmessage = (event) => {
									if (typeof event.data === "string")
										wait()
									else
										displayCommMessage(event.data)
								}
							} else {
								let comm = new XMLHttpRequest()
								comm.responseType = "arraybuffer"
								comm.open("POST", "http://" + ADDR + "/communicate")
								comm.setRequestHeader("X-Gate-Instance-Id", spawned.instance.id)
								comm.send()

								comm.onloadstart = wait
								comm.onprogress = wait
								comm.onloadend = wait

								comm.onload = () => {
									displayCommMessage(comm.response)
								}
							}
						}
					}
				}
			}
		}
	}
}())

		</script>
	</body>
</html>
